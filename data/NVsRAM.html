<HTML>
<HEAD>
<TITLE>IDE Controller NVsRAM Programming</TITLE>
</HEAD>
<BODY BACKGROUND="../images/tile_sidebar.jpg">
<!-- VLINK="#ff00ff" LINK="#4000ff" ALINK="#4000ff" TEXT="#000000" -->
<BASEFONT FACE="Verdana, Arial" SIZE="2">

<table border=0 cellpadding=20 cellspacing=0 align=left width="100%">
<!-- This table is entire page! -->
<tr><td>
<TABLE CELLPADDING="0" CELLSPACING="0" BORDER=0 WIDTH=100%>
<!-- This table is just the first pix & Title. -->
<TR><TD ALIGN="center" VALIGN="middle">
<A HREF="../images/IDEctrlr02.jpg" target="_blank">
<IMG SRC="../images/IDEctrlr02.jpg" BORDER="0" width=400></A>
</TD><TD ALIGN="center"><FONT FACE="Verdana, Arial" SIZE=5>
<B>Z-100 IDE Controller<BR>
Features and<BR>
NVsRAM Programming</B><P> 
</FONT></TD></TR>
</TABLE>

<tr><td ALIGN="center">
<img src="../images/bar.jpg" alt="--Divider--">
</td></tr>

<tr><td align="center" valign="top">
<TABLE CELLPADDING="0" CELLSPACING="0" WIDTH=90%>
<TR><TD ALIGN=left>
<FONT FACE="Verdana, Arial" SIZE=2>
<B>The IDE controller has several important features:</B><P>
-- The board has two IDE 40-pin connectors capable of using several common IDE devices.<P>
-- The board has a bootable and programmable NVsRAM (often referred to as the Eprom chip to stay standard with the terminology used on the Z-100 LLSCSI Controller Board and software).<P>
-- The board has a hardware Breakout switch located at the upper right corner of the IDE controller card. The breakout switch is helpful for troubleshooting software and provided access to the Z-100 ROM monitor diagnostics and capabilities.<P>
-- The board has a header just to the left of the left IDE connector that has a LED indicator plug attached (not shown in the picture). This plug has a green LED and five red LED's to act as an NVsRAM and IDE device status indicator. The right-most two pins are available for a remote Breakout Switch (not included).<P>

Many of these functions will be addressed further below.<P>
</FONT></TD></TR>
</TABLE></td></tr>

<tr><td align="left" valign="top">
<TABLE CELLPADDING="10" CELLSPACING="0" BORDER="0">
<TR><TD ALIGN="center" WIDTH="200">
<img src="../images/bullet.jpg" hspace="0" vspace="0" alt="*"></TD>
<TD WIDTH="100"><A HREF="../images/Altera01.jpg" target="_blank">
<IMG SRC="../images/Altera01x.jpg" BORDER="0"></A>
</TD>
<TD><FONT size=2><B><-- The Altera Chip --><BR>
The IDE Controller's Heart</B></TD></TR>
<TR><TD>&nbsp;</TD><TD colspan=2><FONT size=2>
The programmable Altera chip, EPM7064SLC84, controls several IDE Controller Card's functions:<P>
-- Read/Write functions to the NVsRAM<BR>
-- Read/Write functions to the IDE connectors<BR>
-- Processing the Breakout switch<BR>
-- Provides automatic Wait States for the Controller<P>
A programming header is provided just below the LED header. It requires reconfiguration of the pins and some jumpers when not being used. The programming of the Altera chip is beyond the purpose of this article. I recommend that you try the Altera website, <u>www.altera.com</u>, for further information.<P>
</FONT></TD></TR>

<tr><td align="left" valign="top">
<TR><TD ALIGN="center">
<img src="../images/bullet.jpg" hspace="0" vspace="0" alt="*"></TD>
<TD>&nbsp;</TD>
<TD><FONT size=2><B><-- Breakout Switch --></B></TD></TR>
<TR><TD>&nbsp;</TD><TD colspan=2><FONT size=2>
The Breakout switch is located just to the lower right of the right IDE connector on the top of the board. Pressing it energizes the circuitry just below the Altera chip on the left side to stop the present DOS activity at the DOS prompt and return the computer to the hand prompt. From there, the operator may use any of the monitor commands to test the computer, access certain points in memory, or perform other simple functions. To return to the program press {G}o and {RETURN} twice. The operator is returned to the DOS prompt to continue DOS operations.<P>
</FONT></TD></TR>

<tr><td align="left" valign="top">
<TR><TD ALIGN="center">
<img src="../images/bullet.jpg" hspace="0" vspace="0" alt="*"></TD>
<TD><A HREF="../images/NVsRAM02.jpg" target="_blank">
<IMG SRC="../images/NVsRAM02x.jpg" BORDER="0"></A>
</TD>
<TD><FONT size=2><B><-- NVsRAM (Eprom) --><BR>
With Real Time Clock,<BR>
Z-100 Boot Code<BR>
and other Programs</B></TD></TR>
<TR><TD>&nbsp;</TD><TD colspan=2><FONT size=2>
The NVsRAM (Eprom) provides the boot code necessary for the Z-100 to operate. It has 512K sRAM for loading the boot code, other programs, and also contains a real time clock in the last sector. It is programmable on the card using local software. The remainder of this document will address this capability.<P>
</FONT></TD></TR>
</TABLE></td></tr>

<tr><td align="center" valign="top">
<TABLE CELLPADDING="0" CELLSPACING="0" WIDTH=90%>
<TR><TD ALIGN=left>

<FONT size="3"><B>Reprogramming the NVsRAM (Eprom):</B></FONT><P><FONT size="2">

Every system has been shipped with a preprogrammed NVsRAM for the type of system expected, that is, with or without an MFM hard drive system installed. The NVsRAM is bootable and is designed to be the primary boot device. However, should you desire to change the NVsRAM's programming or if the NVsRAM should lose it's programming for some reason, it can be easily reprogrammed.<P>

The NVsRAM chosen for distribution was the Texas Instruments BQ4850YMA, a 512Kb NVsRAM (non-volatile static RAM) model with real time clock. The Dallas DS1647Y model has similar capabilities and is a direct replacement, if necessary. While these models use only 32 pins, the 36-pin socket was installed to allow using the larger 1024Kb models from both companies. However, if these models include real time clocks, additional hardware and software is required to process this capability. Some clock models include alarms and wakeup capability!<P>

<B>CAUTION:</B> When installing the 32-pin NVsRAMs, ALWAYS leave the four empty pins of the socket to the LEFT! A jumper, located just above the NVsRAM socket, is also required to be modified and jumpered to accommodate the 36-pin units.<P>

<B>Note:</B> Another 2-pin jumper is located just above the NVsRAM that can be cut to ensure write protection to the NVsRAM. When the trace between the pins is cut on the back of the board and a jumper is NOT installed, the NVsRAM will be WRITE-PROTECTED.<P>

The easiest means of reprogramming the NVsRAM is to reload the original programming, using the utility EPWRFILE and a disk image file, EPTEST.DAT. For those individuals who ordered IDE devices with their IDE controller boards, the EPTEST.DAT file was already created by me and saved in two directories on the IDE device: \EPROMPGM (Eprom Programming) and \ORGEPROM (Original Eprom). For those installing their own IDE devices, I recommended in the installation procedures that you do the same using the procedures provided in the next section.<P>

<B>Drive LED Indicator:</B> Located to the left of the IDE connectors is a row of Light Emitting Diodes (LEDs) on the top edge of the board. From left to right, these indicate:<P>

-- NVsRAM Read Operation. This green LED lights whenever the NVsRAM is being Read.<BR>
-- NVsRAM Write Operation. This red LED indicates NVsRAM Write processes and<BR>
&nbsp;&nbsp;&nbsp;&nbsp;should only illuminate when the NVsRAM is being written to.<BR>
-- IDE1 Master Read/Write. These work like typical hard drive LEDs.<BR>
-- IDE1 Slave Read Write.<BR>
-- IDE2 Master Read/Write.<BR>
-- IDE2 Slave Read/Write.<P>

This indicator is a plugin device that may be replaced with leads to a front plate indicator, if desired. The two right-most pins are left unused and may be connected to a remote Breakout Switch, if desired.<P>&nbsp;<P>





<B>Creating an NVsRAM (Eprom) Image File - EPTEST.DAT</B><P>

1. Create two subdirectories on your IDE or MFM drives: \ORGEPROM and \EPROMPGM.<P>
2. Copy all the NVsRAM files to BOTH of these directories.<P>
3. Finally, change the default drive to one of these partitions and run the EPRDFILE utility.<BR>
&nbsp;&nbsp;&nbsp;&nbsp;This utility will create the file EPTEST.DAT containing an image of the NVsRAM's programming in the file.<P>
4. Copy the EPTEST.DAT file to the other subdirectory as a backup.<P>

<B>NOTE:</B> The EPWRFILE uses the image file created by EPRDFILE to reprogram the NVsRAM on the IDE Controller Board. However, it presently appears that we cannot run EPWRFILE with the data file, EPTEST.DAT, located on an IDE device. If the data file is stored on an IDE device, EPWRFILE will appear to work properly, with the IDE LED flashing and it will report that the file was successfully written to the EPROM (NVsRAM), however, if you look carefully you will see that the red NVsRAM LED is NOT flashing, and the file was NOT written to the NVsRAM. Be sure to copy all the programming files, including the EPTEST.DAT file, to an MFM hard drive or create a 3.5" floppy disk and store them there.<P>&nbsp;<P>

<B>Reprogramming the NVsRAM (Eprom) from the EPTEST.DAT file:</B><P>

1. If able, boot to the NVsRAM (Eprom) as usual and change the default drive to the MFM hard drive<BR>
&nbsp;&nbsp;&nbsp;&nbsp;or 3.5" floppy drive containing the reprogramming files.<BR>
2. Run EPWRFILE and watch the red Eprom programming LED to ensure the operation is working.<BR>
3. Reboot to the NVsRAM (Eprom) as usual using the command {B}oot {F4}s. If the programming was successful, the system should boot to the NVsRAM.<BR>
4. If that was not successful, proceed with the following procedures:<P>&nbsp;<P>

<B>Reprogramming the NVsRAM (Eprom) using the Programming Configuration Procedures:</B><P>

1. Boot to the MFM drives or the Z-DOS v4.06 floppy disk.<BR>
2. Interrupt the boot operation when the computer asks to load an alternate Configuration File (you have 3 seconds to press any key).<BR>
3. Press {P} to set the Programming Eprom procedures.<BR>
4. A new line will be added to the Boot screen:<BR>
&nbsp;&nbsp;&nbsp;&nbsp;F: EEPROM /CLOCK(Programming)<P>
5. Note the new drive letter listed for programming the Eprom, as you will need this later.<BR>
6. Change to the MFM \EPROMPGM directory or to the 3.5" reprogramming Floppy created earlier.<BR>
7. Run EPROMPGM X:, where the X: is the drive letter for programming the Eprom.<BR>
8. Once completed, the NVsRAM will be completely programmed and hopefully bootable.<BR>
9. Reboot to the NVsRAM using the command: {B}oot {F4}s
10. If successful, return to the programming directory or 3.5" reprogramming Floppy and run EPRDFILE to update the EPTEST.DAT file. Hint: You can change the name to another file name to protect the original EPTEST.DAT file, in case you need to return to the original programming for some reason. Might I suggest EPTEST.01, etc.<BR>
11. If not successful, please repeat the procedures, or call me.<P>&nbsp;<P>

<B>Changing the programming of the NVsRAM (Eprom):</B><P>

To change the programming of the NVsRAM on the fly, be sure to reboot in the programming mode, copy or delete any files to the NVsRAM as necessary, and finally run CHKSUMEP to create a new checksum on the NVsRAM. However, there is the possibility of really messing things up. I highly recommend just editing EPROMPGM.BAT with EDLIN or another line editor and simply following the above procedures. It does everything automatically.<P>&nbsp;<P>

<B>Closing:</B><P>
I hope you found this document useful. I have found this new booting capability to be extremely fast and reliable and hope you do also. If you have any questions or need help, don't hesitate to e-mail me at the link below.<P> 
</FONT></TD></TR>
</TABLE></td></tr>

<tr>
<td valign="middle" align="center">
<img src="../images/bar.jpg" hspace="0" vspace="0" alt="--Divider--">
<P></td></tr>

<tr>
<td valign="middle" align="center">
<A HREF="mailto:z100lifeline@earthlink.net">
<img src="../images/email.jpg" HSPACE="0" VSPACE="0" BORDER="0"></A><BR>
<A HREF="mailto:z100lifeline@earthlink.net"><FONT FACE="Verdana, Arial" SIZE="4">z100lifeline@earthlink.net</FONT></A><P>
&nbsp;<P>

</td></tr>
<tr>
<td valign="middle" align="center">
<table>
<TR><td align="center"><FONT FACE="Verdana, Arial" SIZE="3">
<A HREF="../index.html">
<img src="../images/bullet.jpg" BORDER="0"></A>
<A HREF="../index.html"> HOME</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</FONT></td>

<td align="center"><FONT FACE="Verdana, Arial" SIZE="3">
<A HREF="../lifeline.html">
<img src="../images/bullet.jpg" BORDER="0"></A>
<A HREF="../lifeline.html"> History Page</A>&nbsp;&nbsp;&nbsp;
</FONT></td>

<td align="center"><FONT FACE="Verdana, Arial" SIZE="3">
<A HREF="../z100.html">
<img src="../images/bullet.jpg" BORDER="0"></A>
<A HREF="../z100.html"> Z-100 Page </A>&nbsp;&nbsp;&nbsp;
</FONT></td>

<td align="center"><FONT FACE="Verdana, Arial" SIZE="3">
<A HREF="../repair.html">
<img src="../images/bullet.jpg" BORDER="0"></A>
<A HREF="../repair.html"> Repair Page </A>
</FONT></td>

</td></tr>
</table>
</td></tr>

<tr>
<td align=center><center>
<table>
<TR><TD VALIGN="top" ALIGN="center" WIDTH="350"><FONT SIZE="-2">
Copyright &copy; 2009, Steven W. Vagts<BR>
Revised -- December 16, 2009<BR>
</FONT></TD>
<TD VALIGN="top" ALIGN="center" WIDTH="176">
<A HREF="http://www.earthlink.net/">
<img src="../images/hosted.jpg" border=0 ALT="Hosted by EarthLink"></A>
</TD></TR>
</TABLE>
</center>
</td></tr>
</table>    
</BODY></HTML>
